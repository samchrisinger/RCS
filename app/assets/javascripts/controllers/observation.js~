app.controller('ObservationCtrl', ['$scope', '$rootScope', '$routeParams', 'Observation', 'Metric', function($scope, $rootScope, $routeParams, Observation, Metric){       
    $scope.current_user = $rootScope.current_user;
    $scope.observation = {};
    if(Object.keys($routeParams).length == 0){
	//new Observation
	var center = $rootScope.map.center;
	$scope.observation.lat = center.latitude;
	$scope.observation.lon = center.longitude;
	$rootScope.map.markers = center;
	var d = new Date();
	$scope.observation.timestamp = d;

	var m = new Date();
	m.setDate(m.getDate() - 7);	
	$scope.dp = {
	    maxDate: d,
	    minDate: m,
	    open: function($event) {
		debugger;
		$event.preventDefault();
		$event.stopPropagation();
		
		$scope.opened = true;
	    }
	};
    }
    else{
	//old Observation
	Observation.get(
	    {id:$routeParams.id,
	     with_metrics:true}, 
	    function(obs){
		$scope.observation = obs;
		$rootScope.map.markers = [{
		    latitude: obs.lat,
		    longitude: obs.lon
		}];
		$rootScope.map.visible = true;
		window.setTimeout(function(){
		    google.maps.event.trigger(m, 'resize');
		}, 200);
	    });
    }
}]);
